<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compound Interest Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1400px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .toggle-comparison {
            text-align: center;
            margin-bottom: 20px;
        }

        .toggle-btn {
            background: #f0f0f0;
            color: #333;
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .comparison-container {
            display: none;
            gap: 20px;
            margin-bottom: 20px;
        }

        .comparison-container.active {
            display: flex;
        }

        .scenario {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: #f9f9f9;
        }

        .scenario h2 {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .container {
                padding: 25px 20px;
                border-radius: 15px;
                margin-top: 10px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 25px;
            }

            .input-group {
                margin-bottom: 18px;
            }

            label {
                font-size: 13px;
            }

            input, select {
                padding: 14px 12px;
                font-size: 16px;
            }

            button {
                padding: 16px;
                font-size: 17px;
            }

            .result {
                padding: 20px;
                margin-top: 25px;
            }

            .result-value {
                font-size: 16px;
            }

            .result-value.highlight {
                font-size: 20px;
            }

            .radio-group {
                gap: 15px;
            }

            .breakdown {
                max-height: 300px;
            }

            .breakdown-table th,
            .breakdown-table td {
                padding: 8px 4px;
                font-size: 11px;
            }

            .breakdown h3 {
                font-size: 14px;
            }

            .comparison-container {
                flex-direction: column;
                gap: 15px;
            }

            .comparison-results {
                flex-direction: column;
                gap: 15px;
            }

            .scenario {
                padding: 15px;
            }

            .scenario h2 {
                font-size: 16px;
            }

            .chart-container {
                height: 250px;
                padding: 15px;
            }

            .chart-container canvas {
                touch-action: none;
            }

            .frequency-selector {
                flex-direction: column;
                gap: 5px;
            }

            .frequency-selector label {
                font-size: 12px;
                margin-bottom: 0;
            }
        }

        @media (max-width: 400px) {
            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 22px;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .result-item {
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
            }
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        select {
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            display: none;
        }

        .result.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #555;
            font-weight: 600;
        }

        .result-value {
            color: #333;
            font-weight: 700;
            font-size: 18px;
        }

        .result-value.highlight {
            color: #667eea;
            font-size: 24px;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            height: 300px;
            position: relative;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            display: none;
            z-index: 100;
            white-space: nowrap;
        }

        .chart-tooltip.show {
            display: block;
        }

        .frequency-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .frequency-selector label {
            font-weight: 600;
            color: #555;
            margin: 0;
        }

        .frequency-selector select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        .growth-comparison {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            display: none;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
        }

        .growth-comparison.show {
            display: block;
        }

        .growth-comparison h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 14px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .growth-comparison .point-info {
            font-size: 12px;
            margin: 5px 0;
            color: #333;
        }

        .growth-comparison .point-info strong {
            color: #667eea;
        }

        .growth-comparison .growth-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .growth-comparison .stat {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }

        .growth-comparison .stat .label {
            color: #666;
        }

        .growth-comparison .stat .value {
            font-weight: bold;
            color: #333;
        }

        .growth-comparison .stat .value.positive {
            color: #10b981;
        }

        .growth-comparison button {
            width: 100%;
            padding: 6px;
            margin-top: 10px;
            font-size: 12px;
            background: #dc2626;
        }

        .growth-comparison button:hover {
            background: #b91c1c;
            font-size: 14px;
            cursor: pointer;
        }

        .breakdown {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .breakdown h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            padding: 15px 15px 0;
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            z-index: 1;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
        }

        .breakdown-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-size: 13px;
            position: sticky;
            top: 46px;
            z-index: 1;
        }

        .breakdown-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .breakdown-table tr:hover {
            background: #f9f9f9;
        }

        .breakdown-table tr:last-child td {
            font-weight: bold;
            background: #f5f7fa;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .comparison-results {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-results .result {
            flex: 1;
            margin-top: 0;
        }

        .comparison-banner {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .comparison-banner.active {
            display: block;
        }

        .comparison-banner button {
            background: white;
            color: #667eea;
            padding: 8px 16px;
            margin-left: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’° Compound Interest Calculator</h1>
        
        <div class="toggle-comparison">
            <button class="toggle-btn" id="toggleComparisonBtn" onclick="toggleComparison()">Enable Comparison Mode</button>
        </div>

        <div id="mainScenario">
            <div class="input-group">
                <label for="startDate">Starting Date</label>
                <input type="month" id="startDate" value="">
            </div>

            <div class="input-group">
                <label for="principal">Initial Principal ($)</label>
                <input type="number" id="principal" placeholder="e.g., 10000" step="0.01" min="0">
                <span class="error" id="principalError">Please enter a valid amount</span>
            </div>

            <div class="input-group">
                <label for="contribution">Regular Contribution ($)</label>
                <input type="number" id="contribution" placeholder="e.g., 500" step="0.01" min="0" value="0">
            </div>

            <div class="input-group">
                <label for="contributionFreq">Contribution Frequency</label>
                <select id="contributionFreq">
                    <option value="0">None</option>
                    <option value="12" selected>Monthly</option>
                    <option value="4">Quarterly</option>
                    <option value="2">Semi-annually</option>
                    <option value="1">Annually</option>
                </select>
            </div>

            <div class="input-group">
                <label>Interest Rate Type</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="annualRate" name="rateType" value="annual" checked>
                        <label for="annualRate">Annual (%)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="monthlyRate" name="rateType" value="monthly">
                        <label for="monthlyRate">Monthly (%)</label>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="rate"><span id="rateLabel">Annual</span> Interest Rate (%)</label>
                <input type="number" id="rate" placeholder="e.g., 5" step="0.01" min="0">
                <span class="error" id="rateError">Please enter a valid rate</span>
            </div>

            <div class="input-group">
                <label for="time">Time Period (years)</label>
                <input type="number" id="time" placeholder="e.g., 10" step="0.1" min="0">
                <span class="error" id="timeError">Please enter a valid time period</span>
            </div>

            <div class="input-group">
                <label for="compound">Compound Frequency (per year)</label>
                <input type="number" id="compound" placeholder="e.g., 12 (monthly)" step="1" min="1" value="12">
                <span class="error" id="compoundError">Please enter a valid frequency</span>
            </div>

            <button id="calculateBtn">Calculate</button>
        </div>

        <div id="comparisonBanner" class="comparison-banner">
            <span id="comparisonText">Comparison Mode Active - First scenario saved. Calculate again to compare.</span>
            <button onclick="clearComparison()">Clear Comparison</button>
        </div>

        <div id="comparisonResults" class="comparison-results"></div>

        <div class="result" id="result">
            <div class="result-item">
                <span class="result-label">Initial Principal:</span>
                <span class="result-value" id="displayPrincipal">$0.00</span>
            </div>
            <div class="result-item">
                <span class="result-label">Total Contributions:</span>
                <span class="result-value" id="displayContributions">$0.00</span>
            </div>
            <div class="result-item">
                <span class="result-label">Total Invested:</span>
                <span class="result-value" id="displayTotalInvested">$0.00</span>
            </div>
            <div class="result-item">
                <span class="result-label">Total Interest Earned:</span>
                <span class="result-value" id="displayInterest">$0.00</span>
            </div>
            <div class="result-item">
                <span class="result-label">Final Amount:</span>
                <span class="result-value highlight" id="displayTotal">$0.00</span>
            </div>

            <div class="frequency-selector">
                <label for="dataFrequency">Chart Data Points:</label>
                <select id="dataFrequency" onchange="updateChartFrequency()">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>

            <div class="chart-container">
                <canvas id="growthChart" class="chart-canvas"></canvas>
            </div>
            
            <div class="breakdown" id="breakdown">
                <h3>ðŸ“Š Monthly Growth Breakdown</h3>
                <table class="breakdown-table" id="breakdownTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Balance</th>
                            <th>Contribution</th>
                            <th>Interest</th>
                        </tr>
                    </thead>
                    <tbody id="breakdownBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Set default start date to current month
        const now = new Date();
        const currentMonth = now.toISOString().slice(0, 7);
        document.getElementById('startDate').value = currentMonth;

        let comparisonMode = false;
        let savedScenario = null;

        function toggleComparison() {
            comparisonMode = !comparisonMode;
            const btn = document.getElementById('toggleComparisonBtn');
            
            btn.textContent = comparisonMode ? 'Disable Comparison Mode' : 'Enable Comparison Mode';
            btn.classList.toggle('active');
            
            if (!comparisonMode) {
                clearComparison();
            }
        }

        function clearComparison() {
            savedScenario = null;
            comparisonMode = false;
            document.getElementById('toggleComparisonBtn').classList.remove('active');
            document.getElementById('toggleComparisonBtn').textContent = 'Enable Comparison Mode';
            document.getElementById('comparisonBanner').classList.remove('active');
            document.getElementById('comparisonResults').innerHTML = '';
        }

        // Update label when rate type changes
        document.querySelectorAll('input[name="rateType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const label = document.getElementById('rateLabel');
                const input = document.getElementById('rate');
                if (this.value === 'annual') {
                    label.textContent = 'Annual';
                    input.placeholder = 'e.g., 5';
                } else {
                    label.textContent = 'Monthly';
                    input.placeholder = 'e.g., 0.4';
                }
            });
        });

        // Scenario A rate type change
        document.querySelectorAll('input[name="rateTypeA"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const label = document.getElementById('rateLabelA');
                const input = document.getElementById('rateA');
                if (this.value === 'annual') {
                    label.textContent = 'Annual';
                    input.placeholder = 'e.g., 5';
                } else {
                    label.textContent = 'Monthly';
                    input.placeholder = 'e.g., 0.4';
                }
            });
        });

        // Scenario B rate type change
        document.querySelectorAll('input[name="rateTypeB"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const label = document.getElementById('rateLabelB');
                const input = document.getElementById('rateB');
                if (this.value === 'annual') {
                    label.textContent = 'Annual';
                    input.placeholder = 'e.g., 5';
                } else {
                    label.textContent = 'Monthly';
                    input.placeholder = 'e.g., 0.4';
                }
            });
        });

        // Add click event listener to button
        document.getElementById('calculateBtn').addEventListener('click', calculateInterest);

        function calculateScenario(scenario) {
            const suffix = scenario;
            
            // Get input values
            const principal = parseFloat(document.getElementById('principal' + suffix).value) || 0;
            let rate = parseFloat(document.getElementById('rate' + suffix).value);
            const time = parseFloat(document.getElementById('time' + suffix).value);
            const compound = parseFloat(document.getElementById('compound' + suffix).value);
            const rateType = document.querySelector('input[name="rateType' + suffix + '"]:checked').value;
            const contribution = parseFloat(document.getElementById('contribution' + suffix).value) || 0;
            const contributionFreq = parseFloat(document.getElementById('contributionFreq' + suffix).value);
            const startDate = document.getElementById('startDate' + suffix).value;

            // Basic validation
            if ((isNaN(principal) || principal < 0) || (principal === 0 && contribution === 0)) {
                alert('Please enter a valid principal or contribution for Scenario ' + scenario);
                return;
            }

            if (isNaN(rate) || rate < 0) {
                alert('Please enter a valid rate for Scenario ' + scenario);
                return;
            }

            if (isNaN(time) || time <= 0) {
                alert('Please enter a valid time period for Scenario ' + scenario);
                return;
            }

            if (isNaN(compound) || compound < 1) {
                alert('Please enter a valid compound frequency for Scenario ' + scenario);
                return;
            }

            // Convert monthly rate to annual if needed
            if (rateType === 'monthly') {
                rate = rate * 12;
            }

            const rateDecimal = rate / 100;

            // Calculate with contributions
            const result = calculateWithContributions(principal, rateDecimal, time, compound, contribution, contributionFreq, startDate);

            // Store result
            if (scenario === 'A') {
                scenarioAData = result;
            } else {
                scenarioBData = result;
            }

            // Display results
            document.getElementById('displayTotal' + suffix).textContent = '$' + result.finalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('displayTotalInvested' + suffix).textContent = '$' + (principal + result.totalContributions).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('displayInterest' + suffix).textContent = '$' + result.totalInterest.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // Show results container
            document.getElementById('comparisonResults').classList.add('active');

            // Generate chart after DOM updates
            setTimeout(() => {
                drawChartForScenario(result.monthlyData, 'growthChart' + suffix);
            }, 10);
        }

        function calculateInterest() {
            // Get input values
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            let rate = parseFloat(document.getElementById('rate').value);
            const time = parseFloat(document.getElementById('time').value);
            const compound = parseFloat(document.getElementById('compound').value);
            const rateType = document.querySelector('input[name="rateType"]:checked').value;
            const contribution = parseFloat(document.getElementById('contribution').value) || 0;
            const contributionFreq = parseFloat(document.getElementById('contributionFreq').value);
            const startDate = document.getElementById('startDate').value;

            // Reset errors
            document.querySelectorAll('.error').forEach(error => error.classList.remove('show'));

            // Validate inputs
            let isValid = true;

            if (isNaN(principal) || principal < 0) {
                document.getElementById('principalError').classList.add('show');
                isValid = false;
            }

            if (principal === 0 && contribution === 0) {
                document.getElementById('principalError').classList.add('show');
                document.getElementById('principalError').textContent = 'Please enter principal or contribution';
                isValid = false;
            } else {
                document.getElementById('principalError').textContent = 'Please enter a valid amount';
            }

            if (isNaN(rate) || rate < 0) {
                document.getElementById('rateError').classList.add('show');
                isValid = false;
            }

            if (isNaN(time) || time <= 0) {
                document.getElementById('timeError').classList.add('show');
                isValid = false;
            }

            if (isNaN(compound) || compound < 1) {
                document.getElementById('compoundError').classList.add('show');
                isValid = false;
            }

            if (!isValid) {
                document.getElementById('result').classList.remove('show');
                return;
            }

            const rateDecimal = rate / 100;

            // Calculate with contributions
            const result = calculateWithContributions(principal, rateDecimal, time, compound, contribution, contributionFreq, startDate, rateType);

            // Display results
            document.getElementById('displayPrincipal').textContent = '$' + principal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('displayContributions').textContent = '$' + result.totalContributions.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('displayTotalInvested').textContent = '$' + (principal + result.totalContributions).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('displayInterest').textContent = '$' + result.totalInterest.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('displayTotal').textContent = '$' + result.finalAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // Update breakdown table
            updateBreakdownTable(result.monthlyData);

            // Show result
            document.getElementById('result').classList.add('show');

            // Generate chart after DOM updates (use setTimeout to ensure canvas is visible)
            setTimeout(() => {
                fullMonthlyData = result.monthlyData;
                const frequency = document.getElementById('dataFrequency').value;
                const filteredData = filterDataByFrequency(result.monthlyData, frequency);
                drawChart(filteredData);
            }, 10);

            // Handle comparison mode
            if (comparisonMode) {
                if (!savedScenario) {
                    // Save first scenario
                    savedScenario = {
                        result: result,
                        inputs: {
                            principal: principal,
                            rate: rateType === 'monthly' ? rate / 12 : rate,
                            time: time,
                            contribution: contribution,
                            contributionFreq: contributionFreq
                        }
                    };
                    document.getElementById('comparisonBanner').classList.add('active');
                    document.getElementById('comparisonText').textContent = 'Scenario 1 saved. Adjust values and calculate again to compare.';
                } else {
                    // Show comparison
                    showComparison(savedScenario, result, principal, contribution);
                }
            }

            // Update comparison if enabled
            if (comparisonMode) {
                updateScenarioDisplay('A', result);
            }
        }

        function showComparison(scenario1, result2, principal2, contribution2) {
            const comparisonDiv = document.getElementById('comparisonResults');
            
            // Calculate difference
            const difference = result2.finalAmount - scenario1.result.finalAmount;
            const percentDiff = ((difference / scenario1.result.finalAmount) * 100).toFixed(2);
            
            comparisonDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 12px; flex: 1;">
                    <h3 style="color: #667eea; text-align: center; margin-bottom: 15px; font-size: 18px;">ðŸ“ˆ Scenario 1 (Saved)</h3>
                    <div class="result-item">
                        <span class="result-label">Initial Principal:</span>
                        <span class="result-value">$${scenario1.inputs.principal.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Contribution:</span>
                        <span class="result-value">$${scenario1.inputs.contribution.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')} (${getFrequencyText(scenario1.inputs.contributionFreq)})</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Interest Rate:</span>
                        <span class="result-value">${scenario1.inputs.rate.toFixed(2)}% annual</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Time Period:</span>
                        <span class="result-value">${scenario1.inputs.time} years</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #667eea; padding-top: 10px; margin-top: 10px;">
                        <span class="result-label">Final Amount:</span>
                        <span class="result-value highlight">$${scenario1.result.finalAmount.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Interest Earned:</span>
                        <span class="result-value">$${scenario1.result.totalInterest.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')}</span>
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 12px; flex: 1;">
                    <h3 style="color: #667eea; text-align: center; margin-bottom: 15px; font-size: 18px;">ðŸ“Š Scenario 2 (Current)</h3>
                    <div class="result-item">
                        <span class="result-label">Initial Principal:</span>
                        <span class="result-value">$${principal2.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Contribution:</span>
                        <span class="result-value">$${contribution2.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')}</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #667eea; padding-top: 10px; margin-top: 10px;">
                        <span class="result-label">Final Amount:</span>
                        <span class="result-value highlight">$${result2.finalAmount.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Interest Earned:</span>
                        <span class="result-value">$${result2.totalInterest.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')}</span>
                    </div>
                    <div class="result-item" style="background: ${difference >= 0 ? '#d4edda' : '#f8d7da'}; padding: 10px; margin-top: 10px; border-radius: 6px;">
                        <span class="result-label" style="font-weight: bold;">Difference:</span>
                        <span class="result-value" style="color: ${difference >= 0 ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${difference >= 0 ? '+' : ''}$${Math.abs(difference).toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')} 
                            (${difference >= 0 ? '+' : ''}${percentDiff}%)
                        </span>
                    </div>
                </div>
            `;
            
            document.getElementById('comparisonText').textContent = 'Comparing Scenario 1 vs Scenario 2. Click "Clear Comparison" to start over.';
        }

        function getFrequencyText(freq) {
            switch(freq) {
                case 12: return 'Monthly';
                case 4: return 'Quarterly';
                case 2: return 'Semi-annually';
                case 1: return 'Annually';
                default: return 'None';
            }
        }

        function calculateWithContributions(principal, rate, years, compoundFreq, contribution, contributionFreq, startDateStr, rateType) {
            const totalMonths = Math.ceil(years * 12);
            const monthlyData = [];
            let balance = principal;
            let totalContributions = 0;
            
            // Parse start date
            const [startYear, startMonth] = startDateStr.split('-').map(Number);
            
            // Determine the base rate to use
            let baseRate;
            if (rateType === 'monthly') {
                // Rate is already monthly, so use it directly
                baseRate = rate;
            } else {
                // Rate is annual, convert to the appropriate period rate
                baseRate = rate;
            }
            
            for (let month = 0; month <= totalMonths; month++) {
                const date = new Date(startYear, startMonth - 1 + month, 1);
                const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                
                let monthlyContribution = 0;
                let monthlyInterest = 0;
                
                if (month > 0) {
                    // Calculate interest based on rate type and compound frequency
                    if (rateType === 'monthly') {
                        // For monthly rate: apply it monthly regardless of compound frequency
                        // but compound within the month based on compoundFreq
                        if (compoundFreq === 365) {
                            // Daily compounding with monthly rate
                            const dailyRate = baseRate / 30; // Approximate days in month
                            const balanceWithInterest = balance * Math.pow(1 + dailyRate, 30);
                            monthlyInterest = balanceWithInterest - balance;
                            balance = balanceWithInterest;
                        } else {
                            // Apply monthly rate once per month
                            const balanceWithInterest = balance * (1 + baseRate);
                            monthlyInterest = balanceWithInterest - balance;
                            balance = balanceWithInterest;
                        }
                    } else {
                        // Annual rate: apply based on compound frequency
                        let applyInterest = false;
                        const periodRate = baseRate / compoundFreq;
                        
                        if (compoundFreq === 12) {
                            // Monthly compounding - apply every month
                            applyInterest = true;
                        } else if (compoundFreq === 4) {
                            // Quarterly - apply every 3 months
                            applyInterest = (month % 3 === 0);
                        } else if (compoundFreq === 2) {
                            // Semi-annually - apply every 6 months
                            applyInterest = (month % 6 === 0);
                        } else if (compoundFreq === 1) {
                            // Annually - apply every 12 months
                            applyInterest = (month % 12 === 0);
                        } else if (compoundFreq === 365) {
                            // Daily compounding with annual rate
                            const dailyRate = baseRate / 365;
                            const daysInMonth = 30; // Average approximation
                            const balanceWithInterest = balance * Math.pow(1 + dailyRate, daysInMonth);
                            monthlyInterest = balanceWithInterest - balance;
                            balance = balanceWithInterest;
                            applyInterest = false; // Already handled above
                        }
                        
                        // Apply interest if it's a compounding period
                        if (applyInterest) {
                            const balanceWithInterest = balance * (1 + periodRate);
                            monthlyInterest = balanceWithInterest - balance;
                            balance = balanceWithInterest;
                        }
                    }
                    
                    // Add contribution based on frequency
                    if (contributionFreq > 0) {
                        const monthsPerContribution = 12 / contributionFreq;
                        if (month % monthsPerContribution === 0) {
                            balance += contribution;
                            monthlyContribution = contribution;
                            totalContributions += contribution;
                        }
                    }
                }
                
                monthlyData.push({
                    month: month,
                    date: dateStr,
                    balance: balance,
                    contribution: monthlyContribution,
                    interest: monthlyInterest,
                    totalInvested: principal + totalContributions
                });
            }
            
            const finalAmount = balance;
            const totalInterest = finalAmount - principal - totalContributions;
            
            return {
                monthlyData,
                finalAmount,
                totalInterest,
                totalContributions
            };
        }

        let chartData = [];
        let chartDimensions = {};
        let fullMonthlyData = [];
        let selectedPoints = [];
        let chartListenersAttached = false;

        function updateChartFrequency() {
            if (fullMonthlyData.length > 0) {
                const frequency = document.getElementById('dataFrequency').value;
                const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                setTimeout(() => {
                    drawChart(filteredData);
                }, 10);
            }
        }
        
        function clearSelection() {
            selectedPoints = [];
            const growthBox = document.querySelector('.growth-comparison');
            if (growthBox) {
                growthBox.classList.remove('show');
            }
            // Redraw chart without selected points
            if (fullMonthlyData.length > 0) {
                const frequency = document.getElementById('dataFrequency').value;
                const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                drawChart(filteredData);
            }
        }

        function filterDataByFrequency(data, frequency) {
            if (frequency === 'monthly') return data;
            
            const filtered = [];
            let interval;
            
            switch(frequency) {
                case 'daily':
                    // For daily, calculate daily points (approximately)
                    const totalMonths = data.length - 1;
                    const totalDays = totalMonths * 30;
                    
                    // Parse the start date from the first data point
                    // data[0].date format is like "Jan 2024"
                    const [startMonthStr, startYearStr] = data[0].date.split(' ');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const startMonthNum = monthNames.indexOf(startMonthStr);
                    const startYearNum = parseInt(startYearStr);
                    const startDate = new Date(startYearNum, startMonthNum, 1);
                    
                    for (let day = 0; day <= totalDays; day++) {
                        const monthIndex = day / 30;
                        const floorMonth = Math.floor(monthIndex);
                        const ceilMonth = Math.min(Math.ceil(monthIndex), data.length - 1);
                        const fraction = monthIndex - floorMonth;
                        
                        // Interpolate between months
                        const balance = data[floorMonth].balance + 
                            (data[ceilMonth].balance - data[floorMonth].balance) * fraction;
                        
                        // Calculate the actual date
                        const newDate = new Date(startDate);
                        newDate.setDate(startDate.getDate() + day);
                        
                        filtered.push({
                            month: day / 30,
                            date: newDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
                            balance: balance,
                            contribution: 0,
                            interest: 0
                        });
                    }
                    break;
                    
                case 'weekly':
                    // Sample approximately every week (7 days = ~0.23 months)
                    const weekInterval = 7 / 30; // Convert days to months
                    for (let i = 0; i < data.length; i += weekInterval) {
                        const index = Math.floor(i);
                        if (index < data.length) {
                            const point = {...data[index]};
                            point.month = i; // Preserve fractional month for correct scaling
                            filtered.push(point);
                        }
                    }
                    // Always include the last point
                    if (filtered[filtered.length - 1] !== data[data.length - 1]) {
                        const lastPoint = {...data[data.length - 1]};
                        lastPoint.month = data.length - 1;
                        filtered.push(lastPoint);
                    }
                    break;
                    
                case 'yearly':
                    // Sample every 12 months
                    for (let i = 0; i < data.length; i += 12) {
                        const point = {...data[i]};
                        point.month = i;
                        filtered.push(point);
                    }
                    // Always include the last point
                    if (filtered[filtered.length - 1].month !== data[data.length - 1].month) {
                        const lastPoint = {...data[data.length - 1]};
                        lastPoint.month = data.length - 1;
                        filtered.push(lastPoint);
                    }
                    break;
            }
            
            return filtered.length > 0 ? filtered : data;
        }

        function drawChart(data) {
            const canvas = document.getElementById('growthChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const leftPadding = 70; // Extra space for y-axis labels and label
            const chartWidth = width - leftPadding - padding;
            const chartHeight = height - padding * 2;
            
            // Store for interaction
            chartData = data;
            chartDimensions = { width, height, padding, leftPadding, chartWidth, chartHeight };
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Find max value - use the actual max month value from data
            const maxBalance = Math.max(...data.map(d => d.balance));
            const maxMonth = Math.max(...data.map(d => d.month));
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(leftPadding, padding);
            ctx.lineTo(leftPadding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(leftPadding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Draw line
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((point, index) => {
                const x = leftPadding + (chartWidth / maxMonth) * point.month;
                const y = height - padding - (chartHeight * (point.balance / maxBalance));
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw area under curve
            ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
            ctx.beginPath();
            ctx.moveTo(leftPadding, height - padding);
            data.forEach((point) => {
                const x = leftPadding + (chartWidth / maxMonth) * point.month;
                const y = height - padding - (chartHeight * (point.balance / maxBalance));
                ctx.lineTo(x, y);
            });
            ctx.lineTo(width - padding, height - padding);
            ctx.closePath();
            ctx.fill();
            
            // Draw data points (invisible but clickable)
            data.forEach((point, index) => {
                const x = leftPadding + (chartWidth / maxMonth) * point.month;
                const y = height - padding - (chartHeight * (point.balance / maxBalance));
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fillStyle = '#667eea';
                ctx.fill();
            });
            
            // Draw selected points with larger circles and labels
            selectedPoints.forEach((selectedPoint, idx) => {
                // Find the closest point in the current filtered data
                const tolerance = 0.1; // month tolerance for matching
                const point = data.find(p => 
                    Math.abs(p.month - selectedPoint.month) < tolerance && 
                    Math.abs(p.balance - selectedPoint.balance) < 1
                );
                if (point) {
                    const x = leftPadding + (chartWidth / maxMonth) * point.month;
                    const y = height - padding - (chartHeight * (point.balance / maxBalance));
                    
                    // Draw outer ring
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, 2 * Math.PI);
                    ctx.strokeStyle = idx === 0 ? '#10b981' : '#f59e0b';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // Draw inner circle
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = idx === 0 ? '#10b981' : '#f59e0b';
                    ctx.fill();
                    
                    // Draw label
                    ctx.font = 'bold 12px Arial';
                    ctx.fillStyle = idx === 0 ? '#10b981' : '#f59e0b';
                    ctx.textAlign = 'center';
                    ctx.fillText(idx === 0 ? 'Start' : 'End', x, y - 15);
                }
            });
            
            // Draw labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            
            // Y-axis labels (from bottom to top: 0 to maxBalance)
            for (let i = 0; i <= 5; i++) {
                const value = (maxBalance / 5) * i;
                const y = height - padding - (chartHeight / 5) * i;
                ctx.fillText('$' + Math.round(value).toLocaleString(), leftPadding - 10, y + 4);
            }
            
            // Y-axis label
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#333';
            ctx.fillText('Total Balance ($)', 0, 0);
            ctx.restore();
            
            // X-axis labels (show first, middle, last) - always show as month/year for readability
            ctx.textAlign = 'center';
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666';
            
            // Format dates to show only month and year
            const formatDateForAxis = (dateStr) => {
                // If already in "Mon YYYY" format, return as is
                if (dateStr.match(/^[A-Za-z]{3} \d{4}$/)) {
                    return dateStr;
                }
                // If in "Mon DD, YYYY" format, extract month and year
                const parts = dateStr.split(',');
                if (parts.length === 2) {
                    const monthDay = parts[0].trim().split(' ');
                    return monthDay[0] + ' ' + parts[1].trim();
                }
                return dateStr;
            };
            
            ctx.fillText(formatDateForAxis(data[0].date), leftPadding, height - padding + 20);
            if (data.length > 2) {
                const midIndex = Math.floor(data.length / 2);
                ctx.fillText(formatDateForAxis(data[midIndex].date), leftPadding + chartWidth / 2, height - padding + 20);
            }
            ctx.fillText(formatDateForAxis(data[data.length - 1].date), leftPadding + chartWidth, height - padding + 20);
            
            // Setup interaction
            setupChartInteraction(canvas, data, maxBalance, maxMonth);
        }

        function drawChartForScenario(data, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const leftPadding = 70;
            const chartWidth = width - leftPadding - padding;
            const chartHeight = height - padding * 2;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Find max value
            const maxBalance = Math.max(...data.map(d => d.balance));
            const maxMonth = data.length - 1;
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(leftPadding, padding);
            ctx.lineTo(leftPadding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(leftPadding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Draw line
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((point, index) => {
                const x = leftPadding + (chartWidth / maxMonth) * point.month;
                const y = height - padding - (chartHeight * (point.balance / maxBalance));
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw area under curve
            ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
            ctx.beginPath();
            ctx.moveTo(leftPadding, height - padding);
            data.forEach((point) => {
                const x = leftPadding + (chartWidth / maxMonth) * point.month;
                const y = height - padding - (chartHeight * (point.balance / maxBalance));
                ctx.lineTo(x, y);
            });
            ctx.lineTo(width - padding, height - padding);
            ctx.closePath();
            ctx.fill();
            
            // Draw data points
            data.forEach((point) => {
                const x = leftPadding + (chartWidth / maxMonth) * point.month;
                const y = height - padding - (chartHeight * (point.balance / maxBalance));
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fillStyle = '#667eea';
                ctx.fill();
            });
            
            // Draw labels
            ctx.fillStyle = '#666';
            ctx.font = '11px Arial';
            ctx.textAlign = 'right';
            
            // Y-axis labels
            for (let i = 0; i <= 5; i++) {
                const value = (maxBalance / 5) * i;
                const y = height - padding - (chartHeight / 5) * i;
                ctx.fillText('$' + Math.round(value).toLocaleString(), leftPadding - 10, y + 4);
            }
            
            // Y-axis label
            ctx.save();
            ctx.translate(12, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.font = 'bold 12px Arial';
            ctx.fillStyle = '#333';
            ctx.fillText('Balance ($)', 0, 0);
            ctx.restore();
            
            // X-axis labels
            ctx.textAlign = 'center';
            ctx.font = '11px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText(data[0].date, leftPadding, height - padding + 20);
            if (data.length > 2) {
                const midIndex = Math.floor(data.length / 2);
                ctx.fillText(data[midIndex].date, leftPadding + chartWidth / 2, height - padding + 20);
            }
            ctx.fillText(data[data.length - 1].date, leftPadding + chartWidth, height - padding + 20);
        }

        function setupChartInteraction(canvas, data, maxBalance, maxMonth) {
            const container = canvas.parentElement;
            let tooltip = container.querySelector('.chart-tooltip');
            
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'chart-tooltip';
                container.appendChild(tooltip);
            }
            
            let growthBox = container.querySelector('.growth-comparison');
            if (!growthBox) {
                growthBox = document.createElement('div');
                growthBox.className = 'growth-comparison';
                container.appendChild(growthBox);
            }
            
            const { width, height, padding, leftPadding, chartWidth, chartHeight } = chartDimensions;
            
            function findNearestPoint(mouseX, mouseY) {
                let nearestPoint = null;
                let minDistance = Infinity;
                
                // Use chartData which is globally updated
                chartData.forEach((point) => {
                    const x = leftPadding + (chartWidth / maxMonth) * point.month;
                    const y = height - padding - (chartHeight * (point.balance / maxBalance));
                    const distance = Math.sqrt(Math.pow(mouseX - x, 2) + Math.pow(mouseY - y, 2));
                    
                    if (distance < minDistance && distance < 30) {
                        minDistance = distance;
                        nearestPoint = { ...point, screenX: x, screenY: y };
                    }
                });
                
                return nearestPoint;
            }
            
            function showTooltip(point, mouseX, mouseY) {
                tooltip.innerHTML = `
                    <strong>${point.date}</strong><br>
                    Balance: $${point.balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}<br>
                    Interest: $${point.interest.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}<br>
                    ${point.contribution > 0 ? `Contribution: $${point.contribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}` : ''}
                `;
                
                const rect = container.getBoundingClientRect();
                let left = mouseX + 10;
                let top = mouseY - 10;
                
                // Adjust if tooltip goes off screen
                if (left + tooltip.offsetWidth > rect.width) {
                    left = mouseX - tooltip.offsetWidth - 10;
                }
                if (top + tooltip.offsetHeight > rect.height) {
                    top = rect.height - tooltip.offsetHeight - 10;
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                tooltip.classList.add('show');
            }
            
            function showGrowthComparison() {
                if (selectedPoints.length !== 2) return;
                
                const point1 = selectedPoints[0];
                const point2 = selectedPoints[1];
                
                // Ensure point1 is earlier than point2
                const [startPoint, endPoint] = point1.month <= point2.month ? 
                    [point1, point2] : [point2, point1];
                
                const balanceGrowth = endPoint.balance - startPoint.balance;
                const percentGrowth = ((endPoint.balance / startPoint.balance - 1) * 100);
                const timeDiff = endPoint.month - startPoint.month;
                const monthsDiff = timeDiff;
                const yearsDiff = (timeDiff / 12).toFixed(2);
                
                growthBox.innerHTML = `
                    <h4>Growth Comparison</h4>
                    <div class="point-info"><strong>Start:</strong> ${startPoint.date}</div>
                    <div class="point-info">$${startPoint.balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    <div class="point-info" style="margin-top: 8px;"><strong>End:</strong> ${endPoint.date}</div>
                    <div class="point-info">$${endPoint.balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    <div class="growth-stats">
                        <div class="stat">
                            <span class="label">Time Period:</span>
                            <span class="value">${yearsDiff} years</span>
                        </div>
                        <div class="stat">
                            <span class="label">Balance Growth:</span>
                            <span class="value positive">$${balanceGrowth.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</span>
                        </div>
                        <div class="stat">
                            <span class="label">Percent Growth:</span>
                            <span class="value positive">${percentGrowth.toFixed(2)}%</span>
                        </div>
                    </div>
                    <button onclick="clearSelection()">Clear Selection</button>
                `;
                
                growthBox.classList.add('show');
            }
            
            // Only attach listeners once
            if (!chartListenersAttached) {
                chartListenersAttached = true;
                
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    const point = findNearestPoint(mouseX, mouseY);
                    
                    if (point) {
                        canvas.style.cursor = 'pointer';
                        showTooltip(point, mouseX, mouseY);
                    } else {
                        canvas.style.cursor = 'crosshair';
                        tooltip.classList.remove('show');
                    }
                });
                
                canvas.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
                
                canvas.addEventListener('click', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    const point = findNearestPoint(mouseX, mouseY);
                    
                    if (point) {
                        // Add point to selection
                        if (selectedPoints.length === 0) {
                            selectedPoints.push(point);
                            // Redraw to show first point
                            const frequency = document.getElementById('dataFrequency').value;
                            const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                            drawChart(filteredData);
                        } else if (selectedPoints.length === 1) {
                            // Add second point
                            selectedPoints.push(point);
                            showGrowthComparison();
                            // Redraw to show both points
                            const frequency = document.getElementById('dataFrequency').value;
                            const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                            drawChart(filteredData);
                        } else {
                            // Reset and start new selection
                            selectedPoints = [point];
                            growthBox.classList.remove('show');
                            // Redraw with new first point
                            const frequency = document.getElementById('dataFrequency').value;
                            const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                            drawChart(filteredData);
                        }
                    }
                });
                
                // Touch support for mobile
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;
                    
                    const point = findNearestPoint(touchX, touchY);
                    
                    if (point) {
                        showTooltip(point, touchX, touchY);
                    }
                });
                
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;
                    
                    const point = findNearestPoint(touchX, touchY);
                    
                    if (point) {
                        showTooltip(point, touchX, touchY);
                    } else {
                        tooltip.classList.remove('show');
                    }
                });
                
                canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    
                    // Get the last touch position before it ended
                    if (e.changedTouches && e.changedTouches.length > 0) {
                        const touch = e.changedTouches[0];
                        const touchX = touch.clientX - rect.left;
                        const touchY = touch.clientY - rect.top;
                        
                        const point = findNearestPoint(touchX, touchY);
                        
                        if (point) {
                            // Add point to selection (same logic as click)
                            if (selectedPoints.length === 0) {
                                selectedPoints.push(point);
                                // Redraw to show first point
                                const frequency = document.getElementById('dataFrequency').value;
                                const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                                drawChart(filteredData);
                            } else if (selectedPoints.length === 1) {
                                // Add second point
                                selectedPoints.push(point);
                                showGrowthComparison();
                                // Redraw to show both points
                                const frequency = document.getElementById('dataFrequency').value;
                                const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                                drawChart(filteredData);
                            } else {
                                // Reset and start new selection
                                selectedPoints = [point];
                                growthBox.classList.remove('show');
                                // Redraw with new first point
                                const frequency = document.getElementById('dataFrequency').value;
                                const filteredData = filterDataByFrequency(fullMonthlyData, frequency);
                                drawChart(filteredData);
                            }
                        }
                    }
                    
                    // Hide tooltip after a delay
                    setTimeout(() => tooltip.classList.remove('show'), 2000);
                });
            }
        }

        function updateBreakdownTable(data) {
            const tbody = document.getElementById('breakdownBody');
            tbody.innerHTML = '';

            // Skip first entry (month 0) and show from month 1 onwards
            for (let i = 1; i < data.length; i++) {
                const point = data[i];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${point.date}</td>
                    <td>$${point.balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                    <td>$${point.contribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                    <td>$${point.interest.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                `;
                tbody.appendChild(row);
            }
        }

        // Allow Enter key to trigger calculation
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    calculateInterest();
                }
            });
        });
    </script>
</body>
</html>
